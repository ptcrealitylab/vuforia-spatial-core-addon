<!DOCTYPE html>
<html lang="en">
<head>
    <script src="objectDefaultFiles/object.js"></script>
    <script src="objectDefaultFiles/pep.min.js"></script>
    <script src="objectDefaultFiles/envelopeContents.js"></script>
    <meta charset="UTF-8">
    <title>draw</title>
    <style>
        #canvas {
            width: 600px;
            height: 600px;
            position: absolute;
            left: 0;
            top: 0;
        }
    </style>
</head>
<body style="width: 600px; height: 734px">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 130 159.08">
    <defs>
        <style>
            .cls-1 {
                opacity: 0.25;
            }
            .cls-2 {
                fill: #fff;
            }
            .cls-3 {
                opacity: 0.5;
            }
            .cls-4 {
                fill: #008480;
            }
            .cls-5 {
                fill: #ff007d;
            }
            .cls-6 {
                fill: #75fbfd;
            }
            .cls-7 {
                fill: lime;
            }
        </style>
    </defs>
    <title>Asset 39</title>
    <g id="Layer_2" data-name="Layer 2">
        <g id="UI">
            <g>
                <g class="cls-1">
                    <rect width="130" height="130" rx="5"/>
                </g>
                <g>
                    <g class="palette" id="white">
                        <polygon class="cls-2" points="49.15 157.67 49.15 136.41 38.02 136.41 27.89 136.41 27.89 146.54 27.89 157.67 49.15 157.67"/>
                        <g class="cls-3">
                            <path d="M49.15,136.4v21.27H27.89V136.4H49.15m1-1.4H26.88a.4.4,0,0,0-.4.4v23.28a.4.4,0,0,0,.4.4H50.16a.4.4,0,0,0,.4-.4V135.4a.4.4,0,0,0-.4-.4Z"/>
                        </g>
                        <g class="cls-1">
                            <path class="cls-4" d="M47.75,137.81v18.46H29.29V137.81H47.75m1.4-1.41H27.89v21.27H49.15V136.4Z"/>
                        </g>
                    </g>
                    <g class="palette" id="red">
                        <polygon class="cls-5" points="75.64 157.67 75.64 136.41 64.5 136.41 54.37 136.41 54.37 146.54 54.37 157.67 75.64 157.67"/>
                        <g class="cls-3">
                            <path d="M75.63,136.4v21.27H54.37V136.4H75.63m1-1.4H53.36a.4.4,0,0,0-.4.4v23.28a.4.4,0,0,0,.4.4H76.64a.4.4,0,0,0,.4-.4V135.4a.4.4,0,0,0-.4-.4Z"/>
                        </g>
                        <g class="cls-1">
                            <path class="cls-4" d="M74.23,137.81v18.46H55.77V137.81H74.23m1.4-1.41H54.37v21.27H75.63V136.4Z"/>
                        </g>
                    </g>
                    <g class="palette" id="blue">
                        <polygon class="cls-6" points="102.11 157.67 102.11 136.41 90.98 136.41 80.85 136.41 80.85 146.54 80.85 157.67 102.11 157.67"/>
                        <g class="cls-3">
                            <path d="M102.12,136.4v21.27H80.85V136.4h21.27m1-1.4H79.84a.4.4,0,0,0-.4.4v23.28a.4.4,0,0,0,.4.4h23.28a.4.4,0,0,0,.4-.4V135.4a.4.4,0,0,0-.4-.4Z"/>
                        </g>
                        <g class="cls-1">
                            <path class="cls-4" d="M100.71,137.81v18.46H82.25V137.81h18.46m1.41-1.41H80.85v21.27h21.27V136.4Z"/>
                        </g>
                    </g>
                    <g class="palette" id="green">
                        <polygon class="cls-7" points="128.59 157.67 128.59 136.41 117.46 136.41 107.33 136.41 107.33 146.54 107.33 157.67 128.59 157.67"/>
                        <g class="cls-3">
                            <path d="M128.6,136.4v21.27H107.33V136.4H128.6m1-1.4H106.32a.4.4,0,0,0-.4.4v23.28a.4.4,0,0,0,.4.4H129.6a.4.4,0,0,0,.4-.4V135.4a.4.4,0,0,0-.4-.4Z"/>
                        </g>
                        <g class="cls-1">
                            <path class="cls-4" d="M127.19,137.81v18.46H108.73V137.81h18.46m1.41-1.41H107.33v21.27H128.6V136.4Z"/>
                        </g>
                    </g>
                    <g id="new">
                        <g class="cls-3">
                            <polygon class="cls-4" points="22.67 157.67 22.67 136.41 11.54 136.41 1.41 136.41 1.41 146.54 1.41 157.67 22.67 157.67"/>
                        </g>
                        <path class="cls-7" d="M22.67,136.4v21.27H1.4V136.4H22.67m1-1.4H.4a.4.4,0,0,0-.4.4v23.28a.4.4,0,0,0,.4.4H23.68a.4.4,0,0,0,.4-.4V135.4a.4.4,0,0,0-.4-.4Z"/>
                        <g class="cls-1">
                            <path class="cls-7" d="M21.27,137.81v18.46H2.81V137.81H21.27m1.4-1.41H1.4v21.27H22.67V136.4Z"/>
                        </g>
                        <polygon class="cls-7" points="17.87 148.25 17.87 145.83 13.25 145.83 13.25 141.21 10.83 141.21 10.83 145.83 6.21 145.83 6.21 148.25 10.83 148.25 10.83 152.87 13.25 152.87 13.25 148.25 17.87 148.25"/>
                    </g>
                </g>
            </g>
        </g>
    </g>
</svg>
<canvas id="canvas" width="600px" height="600px"></canvas>

<script>
    try {
        var realityInterface = new RealityInterface();
        realityInterface.initNode('storage', 'storeData');
        realityInterface.initNode('color', 'color', 0, 0);

        var _envelopeContents = new EnvelopeContents(realityInterface, document.body);
        realityInterface.setMoveDelay(500);

        realityInterface.addReadListener('color', function(e) {
            let thisColor = e.value;
            if (typeof thisColor.h !== 'undefined' && typeof thisColor.s !== 'undefined' && typeof thisColor.l !== 'undefined') {

                color = hslString(thisColor); //window.getComputedStyle(el.children[0]).fill;
                ctx.beginPath();
                ctx.strokeStyle = color;
                
                // colorPicker.color.hsv = {
                //     h: color.h,
                //     s: color.s,
                //     v: color.l // l becomes v
                // };
            }
        });
    } catch (e) {
        console.warn('Reality Interface is not accessible');
    }

    var imageContent = [];
    var color = "rgb(41,253,47)";

    var ctx = document.getElementById("canvas").getContext("2d");
    ctx.strokeStyle = color;
    ctx.lineWidth = 10;
    var canvasSize = 600;

    document.addEventListener( "DOMContentLoaded", function(){
        setTimeout(function(){
            newCanvas();
        }, 100);

        // start out with green selected
        var border = document.querySelector('#green').querySelector('.cls-3');
        border.setAttribute('class', 'cls-8');
        border.setAttribute('fill', 'lime');
        
    }, false );

    function newCanvas(){
        drawPointerEvents();
        
        document.querySelector('#new').addEventListener('pointerdown', clearCanvas);

        document.querySelectorAll('.palette').forEach(function(palette){
            palette.addEventListener('pointerdown', function() {
                selectColor(palette);
            });
        });
    }

    function clearCanvas(){
        ctx.clearRect(0, 0, canvasSize, canvasSize);
        imageContent = [];
        realityInterface.writePublicData("storage", "data",  imageContent);
    }

    function selectColor(el){
        for(var i=0;i<document.getElementsByClassName("palette").length;i++) {
            var thisElt = document.getElementsByClassName("palette");
            if (thisElt !== el) {
                var selectedBorder = document.getElementsByClassName("palette")[i].querySelector('.cls-8');
                if (selectedBorder) {
                    selectedBorder.setAttribute('class', 'cls-3');
                    selectedBorder.setAttribute('fill', 'black');
                    // selectedBorder.removeAttribute('fill');
                }
            }
        }
        
        el.querySelector('.cls-3').setAttribute('class', 'cls-8');
        el.querySelector('.cls-8').setAttribute('fill', window.getComputedStyle(el.children[0]).fill);
        
        color = window.getComputedStyle(el.children[0]).fill;
        ctx.beginPath();
        ctx.strokeStyle = color;

        let hslColor;
        if (color.includes('#')) {
            hslColor = hexToHSL(color);
        }
        else if (color.includes('rgb')) {
            hslColor = RGBToHSL(color);
        }
        realityInterface.write('color', hslColor, 'c', 'color'); // todo: should color unit be "hsv" instead?
    }

    var touchDrawOffset = 0;
    // prototype to	start drawing on mouse using canvas moveTo and lineTo
    var drawPointerEvents = function() {
        var clicked = 0;
        var start = function(e) {
            if(!imageContent) imageContent = [];
            clicked = 1;
            var x = e.clientX;
            var y = e.clientY-touchDrawOffset;
            moveTo(x,y,color, ctx);
            imageContent.push({c : color, x : x, y : y});
        };
        var move = function(e) {

            if(clicked){
                if(!imageContent) imageContent = [];
                x = e.clientX;
                y = e.clientY-touchDrawOffset;
                lineTo(x,y, ctx);
                imageContent.push({x : x, y : y});

                realityInterface.writePublicData("storage", "data",  imageContent, true);
            }

        };
        var stop = function(e) {
            clicked = 0;
            realityInterface.writePublicData("storage", "data",  imageContent);
        };
        document.getElementById("canvas").addEventListener("pointerdown", start, false);
        document.getElementById("canvas").addEventListener("pointermove", move, false);
        document.addEventListener("pointerup", stop, false);
    };

    function moveTo(x,y,c, ctx){
        ctx.strokeStyle = c;
        ctx.beginPath();
        ctx.moveTo(x,y);
    }

    function lineTo(x,y, ctx){
        ctx.lineTo(x,y);
        ctx.stroke();
    }

    realityInterface.addReadPublicDataListener('storage', "data", function (e) {
        var ctx = document.getElementById("canvas").getContext("2d");
        ctx.lineWidth = 10;

        if(Array.isArray(e)) {
            imageContent = e;
        }

        if (e.length === 0) {
            clearCanvas();
        }

        for(var i =0; i<e.length; i++){
            var point = e[i];
            if("c" in point){
                moveTo(point.x, point.y, point.c, ctx);
            } else {
                lineTo(point.x, point.y, ctx);
            }
        }
        // document.querySelector('#show').style.visibility = "visible";
    });

    // @author - https://css-tricks.com/converting-color-spaces-in-javascript/
    function hexToHSL(H) {
        // Convert hex to RGB first
        let r = 0, g = 0, b = 0;
        if (H.length == 4) {
            r = "0x" + H[1] + H[1];
            g = "0x" + H[2] + H[2];
            b = "0x" + H[3] + H[3];
        } else if (H.length == 7) {
            r = "0x" + H[1] + H[2];
            g = "0x" + H[3] + H[4];
            b = "0x" + H[5] + H[6];
        }
        // Then to HSL
        r /= 255;
        g /= 255;
        b /= 255;
        let cmin = Math.min(r,g,b),
            cmax = Math.max(r,g,b),
            delta = cmax - cmin,
            h = 0,
            s = 0,
            l = 0;

        if (delta == 0)
            h = 0;
        else if (cmax == r)
            h = ((g - b) / delta) % 6;
        else if (cmax == g)
            h = (b - r) / delta + 2;
        else
            h = (r - g) / delta + 4;

        h = Math.round(h * 60);

        if (h < 0)
            h += 360;

        l = (cmax + cmin) / 2;
        s = delta == 0 ? 0 : delta / (1 - Math.abs(2 * l - 1));
        s = +(s * 100).toFixed(1);
        l = +(l * 100).toFixed(1);

        return {
            h: h,
            s: s,
            l: l
        }
        // return "hsl(" + h + "," + s + "%," + l + "%)";
    }

    function RGBToHSL(r,g,b) {
        // Make r, g, and b fractions of 1
        r /= 255;
        g /= 255;
        b /= 255;

        // Find greatest and smallest channel values
        let cmin = Math.min(r,g,b),
            cmax = Math.max(r,g,b),
            delta = cmax - cmin,
            h = 0,
            s = 0,
            l = 0;

        // Calculate hue
        // No difference
        if (delta == 0)
            h = 0;
        // Red is max
        else if (cmax == r)
            h = ((g - b) / delta) % 6;
        // Green is max
        else if (cmax == g)
            h = (b - r) / delta + 2;
        // Blue is max
        else
            h = (r - g) / delta + 4;

        h = Math.round(h * 60);

        // Make negative hues positive behind 360Â°
        if (h < 0)
            h += 360;

        // Calculate lightness
        l = (cmax + cmin) / 2;

        // Calculate saturation
        s = delta == 0 ? 0 : delta / (1 - Math.abs(2 * l - 1));

        // Multiply l and s by 100
        s = +(s * 100).toFixed(1);
        l = +(l * 100).toFixed(1);

        // return "hsl(" + h + "," + s + "%," + l + "%)";
        
        return {
            h: h,
            s: s,
            l: l
        }
    }
    
    // HSL from nodes is of the scale 0-255 (h) and 0-100 (s and l)
    function hslString(hsl) {
        return "hsl(" + hsl.h + "," + hsl.s + "%," + hsl.l + "%)";
    }

</script>

</body>
</html>
